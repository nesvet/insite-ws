{
  "version": 3,
  "sources": ["../src/server/WebSocketServer.js", "../src/extendEventEmitter.js", "../src/server/symbols.js", "../src/server/WebSocketServerClient.js"],
  "sourcesContent": ["import http from \"node:http\";\nimport https from \"node:https\";\nimport { debounce } from \"@nesvet/n\";\nimport { WebSocketServer } from \"ws\";\nimport { heartbeatGap, heartbeatInterval } from \"../common\";\nimport { extendEventEmitter } from \"../extendEventEmitter\";\nimport { defibSymbol, heartbeatIntervalSymbol, pingTsSymbol } from \"./symbols\";\nimport { WebSocketServerClient } from \"./WebSocketServerClient\";\n\n\nclass InSiteWebSocketServer extends WebSocketServer {\n\tconstructor(options = {}, props, handleListen) {\n\t\tconst {\n\t\t\tupgrade,\n\t\t\tssl,\n\t\t\tport,\n\t\t\tserver = ssl ? https.createServer({ ...ssl }) : http.createServer(),\n\t\t\t...wssOptions\n\t\t} = options;\n\t\t\n\t\tsuper({\n\t\t\t...wssOptions,\n\t\t\tWebSocket: WebSocketServerClient,\n\t\t\tserver\n\t\t});\n\t\t\n\t\textendEventEmitter(this);\n\t\t\n\t\tif (\"upgrade\" in this)\n\t\t\tthrow new Error(\"WebSocketServer now contains an \\\"upgrade\\\" property\");\n\t\t\n\t\tif (props)\n\t\t\tif (typeof props == \"function\") {\n\t\t\t\thandleListen = props;\n\t\t\t\tprops = undefined;\n\t\t\t} else\n\t\t\t\tObject.assign(this, props);\n\t\t\n\t\tthis.upgrade = upgrade;\n\t\t\n\t\tthis.on(\"connection\", this.#handleConnection);\n\t\t\n\t\tserver.listen(port, handleListen);\n\t\t\n\t}\n\t\n\tisWebSocketServer = true;\n\t\n\t#handleConnection(ws, request) {\n\t\tws.wss = this;\n\t\t\n\t\tws.userAgent = request.headers[\"user-agent\"];\n\t\tws.remoteAddress = request.headers[\"x-real-ip\"] ?? request.headers[\"x-forwarded-for\"] ?? \"127.0.0.1\";\n\t\t\n\t\tws.on(\"message\", InSiteWebSocketServer.handleClientMessage);\n\t\tws.on(\"error\", InSiteWebSocketServer.handleClientError);\n\t\tws.on(\"close\", InSiteWebSocketServer.handleClientClose);\n\t\t\n\t\tws[defibSymbol] = debounce(() => ws.terminate(), heartbeatInterval + heartbeatGap);\n\t\tws[defibSymbol]();\n\t\t\n\t\tws.latency = 0;\n\t\t\n\t\tws[heartbeatIntervalSymbol] = setInterval(() => {\n\t\t\t\n\t\t\tws[pingTsSymbol] = Date.now();\n\t\t\tws.send(\"\");\n\t\t\t\n\t\t}, heartbeatInterval);\n\t\t\n\t\tthis.emit(\"client-connect\", ws, request);\n\t\t\n\t}\n\t\n\tstatic handleClientMessage(data) {\n\t\tconst message = data.toString();\n\t\t\n\t\tthis[defibSymbol]();\n\t\t\n\t\tif (message)\n\t\t\ttry {\n\t\t\t\tconst [ kind, ...rest ] = JSON.parse(message);\n\t\t\t\t\n\t\t\t\tthis.emit(`message:${kind}`, ...rest);\n\t\t\t\tthis.wss.emit(\"client-message\", this, kind, ...rest);\n\t\t\t\tthis.wss.emit(`client-message:${kind}`, this, ...rest);\n\t\t\t} catch (error) {\n\t\t\t\tInSiteWebSocketServer.handleClientError.call(this, error);\n\t\t\t}\n\t\t else if (this[pingTsSymbol]) {\n\t\t\tthis.latency = Date.now() - this[pingTsSymbol];\n\t\t\tdelete this[pingTsSymbol];\n\t\t}\n\t\t\n\t}\n\t\n\tstatic handleClientError(error) {\n\t\tif (error instanceof Event)\n\t\t\terror = undefined;\n\t\t\n\t\tif (process.env.NODE_ENV === \"development\")\n\t\t\tconsole.error(\"WebSocketServer Client error\", error);\n\t\t\n\t\tthis.wss.emit(\"client-error\", this, error);\n\t\t\n\t}\n\t\n\tstatic handleClientClose(...args) {\n\t\t\n\t\tif (process.env.NODE_ENV === \"development\")\n\t\t\tconsole.info(\"WebSocketServer Client closed\", ...args);\n\t\t\n\t\tthis[defibSymbol].clear();\n\t\tclearInterval(this[heartbeatIntervalSymbol]);\n\t\t\n\t\tthis.wss.emit(\"client-close\", this);\n\t\tthis.wss.emit(\"client-closed\", this);\n\t\t\n\t}\n\t\n}\n\nexport { InSiteWebSocketServer as WebSocketServer };\n", "/** @this EventEmitter */\nfunction extendedOn(...args) {\n\t\n\tfor (const listenerHandler of this.listenerHandlers)\n\t\tif (listenerHandler.call(this, true, ...args) !== undefined)\n\t\t\treturn;\n\t\n\tthis.directOn(...args);\n\t\n}\n\n/** @this EventEmitter */\nfunction extendedOnce(...args) {\n\t\n\tfor (const listenerHandler of this.listenerHandlers)\n\t\tif (listenerHandler.call(this, true, ...args) !== undefined)\n\t\t\treturn;\n\t\n\tthis.directOnce(...args);\n\t\n}\n\n/** @this EventEmitter */\nfunction extendedOff(...args) {\n\t\n\tfor (const listenerHandler of this.listenerHandlers)\n\t\tif (listenerHandler.call(this, false, ...args) !== undefined)\n\t\t\treturn;\n\t\n\tthis.directOff(...args);\n\t\n}\n\nexport function extendEventEmitter(eventEmitter) {\n\t\n\teventEmitter.directOn = eventEmitter.on;\n\teventEmitter.directOnce = eventEmitter.once;\n\teventEmitter.directOff = eventEmitter.off;\n\t\n\teventEmitter.listenerHandlers = new Set();\n\t\n\teventEmitter.on = extendedOn;\n\teventEmitter.once = extendedOnce;\n\teventEmitter.off = extendedOff;\n\t\n}\n", "export const heartbeatIntervalSymbol = Symbol(\"heartbeatInterval\");\nexport const defibSymbol = Symbol(\"defib\");\nexport const pingTsSymbol = Symbol(\"pingTs\");\n", "import WebSocket from \"ws\";\n\n\nclass InSiteWebSocketServerClient extends WebSocket {\n\t\n\tisWebSocketServerClient = true;\n\t\n\tget isConnecting() {\n\t\treturn this.readyState === this.CONNECTING;\n\t}\n\t\n\tget isOpen() {\n\t\treturn this.readyState === this.OPEN;\n\t}\n\t\n\tget isClosing() {\n\t\treturn this.readyState === this.CLOSING;\n\t}\n\t\n\tget isClosed() {\n\t\treturn this.readyState === this.CLOSED;\n\t}\n\t\n\tsendMessage(...args) {\n\t\tthis.send(JSON.stringify(args));\n\t\t\n\t}\n\t\n}\n\nexport { InSiteWebSocketServerClient as WebSocketServerClient };\n"],
  "mappings": "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",
  "names": ["http", "https", "debounce", "WebSocketServer", "extendedOn", "args", "listenerHandler", "extendedOnce", "extendedOff", "extendEventEmitter", "eventEmitter", "heartbeatIntervalSymbol", "defibSymbol", "pingTsSymbol", "WebSocket", "InSiteWebSocketServerClient", "args", "InSiteWebSocketServer", "_InSiteWebSocketServer", "WebSocketServer", "options", "props", "handleListen", "upgrade", "ssl", "port", "server", "https", "http", "wssOptions", "InSiteWebSocketServerClient", "extendEventEmitter", "#handleConnection", "ws", "request", "defibSymbol", "debounce", "heartbeatIntervalSymbol", "pingTsSymbol", "data", "message", "kind", "rest", "error", "args"]
}
