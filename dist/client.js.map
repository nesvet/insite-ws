{
  "version": 3,
  "sources": ["../src/client/WebSocket.js", "../src/extendEventEmitter.js"],
  "sourcesContent": ["import { debounce, noop } from \"@nesvet/n\";\nimport EventEmitter from \"eventemitter3\";\nimport { heartbeatGap, heartbeatInterval } from \"../common\";\nimport { extendEventEmitter } from \"../extendEventEmitter\";\n\n\nconst reconnectTimeout = 2000;\n\nlet i = 0;\n\n\nclass InSiteWebSocket extends EventEmitter {\n\tconstructor(url, options = {}) {\n\t\tsuper();\n\t\t\n\t\textendEventEmitter(this);\n\t\t\n\t\tthis.url = url;\n\t\t\n\t\tconst {\n\t\t\tname = i++,\n\t\t\tprotocols,\n\t\t\timmediately = true,\n\t\t\tautoReconnect = true,\n\t\t\ton\n\t\t} = options;\n\t\t\n\t\tthis.name = name;\n\t\t\n\t\tthis.protocols = protocols;\n\t\t\n\t\tthis.autoReconnect = autoReconnect;\n\t\t\n\t\tif (on)\n\t\t\tfor (const eventName in on)\n\t\t\t\tif (on[eventName])\n\t\t\t\t\tthis.on(eventName, on[eventName]);\n\t\t\n\t\tif (this.url && immediately)\n\t\t\tthis.open().catch(noop);\n\t\t\n\t}\n\t\n\twebSocket = null;\n\t\n\t#defib = debounce(function () {\n\t\t\n\t\tif (this.isOpen) {\n\t\t\tif (process.env.NODE_ENV === \"development\")\n\t\t\t\tconsole.info(`WebSocket ${this.name} has no heartbeat - going offline`);\n\t\t\t\n\t\t\tthis.webSocket.close();\n\t\t}\n\t\t\n\t}, heartbeatInterval + heartbeatGap);\n\t\n\t#openResolve;\n\t#openReject;\n\t\n\tget isConnecting() {\n\t\treturn this.webSocket ? this.webSocket.readyState === this.webSocket.CONNECTING : null;\n\t}\n\t\n\tget isOpen() {\n\t\treturn this.webSocket ? this.webSocket.readyState === this.webSocket.OPEN : null;\n\t}\n\t\n\tget isClosing() {\n\t\treturn this.webSocket ? this.webSocket.readyState === this.webSocket.CLOSING : null;\n\t}\n\t\n\tget isClosed() {\n\t\treturn this.webSocket ? this.webSocket.readyState === this.webSocket.CLOSED : null;\n\t}\n\t\n\tisChanged = false;\n\t\n\t#handleWebSocketOpen = () => {\n\t\t\n\t\tthis.#openResolve();\n\t\tthis.#openResolve = undefined;\n\t\tthis.#openReject = undefined;\n\t\t\n\t\tthis.emit(\"open\");\n\t\t\n\t\tthis.#defib();\n\t\t\n\t};\n\t\n\t#handleWebSocketMessage = ({ data: message }) => {\n\t\t\n\t\tthis.#defib();\n\t\t\n\t\tif (message)\n\t\t\ttry {\n\t\t\t\tconst [ kind, ...rest ] = JSON.parse(message);\n\t\t\t\t\n\t\t\t\tthis.emit(\"message\", kind, ...rest);\n\t\t\t\tthis.emit(`message:${kind}`, ...rest);\n\t\t\t} catch (error) {\n\t\t\t\tthis.#handleWebSocketError(error);\n\t\t\t}\n\t\t else\n\t\t\tthis.webSocket.send(\"\");\n\t\t\n\t};\n\t\n\t#handleWebSocketError = error => {\n\t\tif (error instanceof Event)\n\t\t\terror = undefined;\n\t\t\n\t\tif (this.#openReject) {\n\t\t\tthis.#openReject(error);\n\t\t\tthis.#openResolve = undefined;\n\t\t\tthis.#openReject = undefined;\n\t\t}\n\t\t\n\t\tthis.emit(\"error\", error);\n\t\t\n\t};\n\t\n\t#reconnectTimeout;\n\t\n\t#handleWebSocketClose = event => {\n\t\t\n\t\tif (process.env.NODE_ENV === \"development\")\n\t\t\tconsole.info(`WebSocket ${this.name} is closed with code ${event.code} and reason \"${event.reason}\"`);\n\t\t\n\t\tthis.#defib.clear();\n\t\t\n\t\tthis.emit(\"close\", event);\n\t\t\n\t\tif (this.autoReconnect && ![ 1002, 3500, 4000 ].includes(event.code)) {\n\t\t\tif (process.env.NODE_ENV === \"development\")\n\t\t\t\tconsole.info(`WebSocket ${this.name} will try to reconnect in 2 sec\u2026`);\n\t\t\t\n\t\t\tthis.#reconnectTimeout = setTimeout(() => this.open().catch(noop), reconnectTimeout);\n\t\t}\n\t\t\n\t};\n\t\n\topen(options = {}) {\n\t\t\n\t\tclearTimeout(this.#reconnectTimeout);\n\t\t\n\t\treturn this.close(4000, \"reopen\").then(() => {\n\t\t\t\n\t\t\tif (options.url)\n\t\t\t\tthis.url = options.url;\n\t\t\t\n\t\t\tif (options.protocols)\n\t\t\t\tthis.protocols = options.protocols;\n\t\t\t\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.#openResolve = resolve;\n\t\t\t\tthis.#openReject = reject;\n\t\t\t\t\n\t\t\t\tif (this.webSocket) {\n\t\t\t\t\tthis.isChanged = this.webSocket._url !== this.url;\n\t\t\t\t\tif (this.isChanged)\n\t\t\t\t\t\tthis.emit(\"server-change\");\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tthis.webSocket = new WebSocket(this.url, this.protocols);\n\t\t\t\tthis.webSocket._url = this.url;\n\t\t\t\t\n\t\t\t\tthis.emit(\"connecting\");\n\t\t\t\t\n\t\t\t\tthis.send = this.webSocket.send.bind(this.webSocket);\n\t\t\t\t\n\t\t\t\tthis.webSocket.addEventListener(\"open\", this.#handleWebSocketOpen);\n\t\t\t\tthis.webSocket.addEventListener(\"message\", this.#handleWebSocketMessage);\n\t\t\t\tthis.webSocket.addEventListener(\"error\", this.#handleWebSocketError);\n\t\t\t\tthis.webSocket.addEventListener(\"close\", this.#handleWebSocketClose);\n\t\t\t\t\n\t\t\t});\n\t\t});\n\t}\n\t\n\tconnect = this.open;\n\t\n\tclose(code = 3500, reason = \"manual\") {\n\t\t\n\t\tclearTimeout(this.#reconnectTimeout);\n\t\t\n\t\treturn new Promise(resolve => {\n\t\t\tif (this.isConnecting || this.isOpen) {\n\t\t\t\tthis.webSocket.addEventListener(\"close\", resolve);\n\t\t\t\tthis.webSocket.close(code, reason);\n\t\t\t} else\n\t\t\t\tresolve();\n\t\t\t\n\t\t});\n\t}\n\t\n\tdisconnect = this.close;\n\t\n\t#queue = [];\n\t\n\t#releaseQueue = () => {\n\t\t\n\t\tfor (const message of this.#queue)\n\t\t\tthis.webSocket.send(message);\n\t\t\n\t\tthis.#queue.length = 0;\n\t\t\n\t};\n\t\n\tsendMessage(...args) {\n\t\tconst message = JSON.stringify(args);\n\t\t\n\t\tif (this.isOpen)\n\t\t\tthis.webSocket.send(message);\n\t\telse {\n\t\t\tif (!this.#queue.length)\n\t\t\t\tthis.once(\"open\", this.#releaseQueue);\n\t\t\t\n\t\t\tthis.#queue.push(message);\n\t\t}\n\t\t\n\t}\n\t\n}\n\nexport { InSiteWebSocket as WebSocket };\n", "/** @this EventEmitter */\nfunction extendedOn(...args) {\n\t\n\tfor (const listenerHandler of this.listenerHandlers)\n\t\tif (listenerHandler.call(this, true, ...args) !== undefined)\n\t\t\treturn;\n\t\n\tthis.directOn(...args);\n\t\n}\n\n/** @this EventEmitter */\nfunction extendedOnce(...args) {\n\t\n\tfor (const listenerHandler of this.listenerHandlers)\n\t\tif (listenerHandler.call(this, true, ...args) !== undefined)\n\t\t\treturn;\n\t\n\tthis.directOnce(...args);\n\t\n}\n\n/** @this EventEmitter */\nfunction extendedOff(...args) {\n\t\n\tfor (const listenerHandler of this.listenerHandlers)\n\t\tif (listenerHandler.call(this, false, ...args) !== undefined)\n\t\t\treturn;\n\t\n\tthis.directOff(...args);\n\t\n}\n\nexport function extendEventEmitter(eventEmitter) {\n\t\n\teventEmitter.directOn = eventEmitter.on;\n\teventEmitter.directOnce = eventEmitter.once;\n\teventEmitter.directOff = eventEmitter.off;\n\t\n\teventEmitter.listenerHandlers = new Set();\n\t\n\teventEmitter.on = extendedOn;\n\teventEmitter.once = extendedOnce;\n\teventEmitter.off = extendedOff;\n\t\n}\n"],
  "mappings": "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",
  "names": ["debounce", "noop", "EventEmitter", "extendedOn", "args", "listenerHandler", "extendedOnce", "extendedOff", "extendEventEmitter", "eventEmitter", "reconnectTimeout", "i", "_defib", "_openResolve", "_openReject", "_handleWebSocketOpen", "_handleWebSocketMessage", "_handleWebSocketError", "_reconnectTimeout", "_handleWebSocketClose", "_queue", "_releaseQueue", "InSiteWebSocket", "EventEmitter", "url", "options", "__publicField", "__privateAdd", "debounce", "__privateGet", "__privateSet", "message", "kind", "rest", "error", "event", "noop", "extendEventEmitter", "name", "protocols", "immediately", "autoReconnect", "on", "eventName", "resolve", "reject", "code", "reason", "args"]
}
